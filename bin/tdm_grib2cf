#!/usr/bin/env python

"""\
Convert a sequence of grib2 files to a single NetCDF4 dataset using the
NetCDF Climate and Forecast (CF) Metadata Conventions
(http://cfconventions.org) Version 1.6.
"""

import argparse
import os
import sys

import cdo


def get_gribs(args):
    gribs = []
    for name in os.listdir(args.input):
        if not name.endswith(".grib2"):
            continue
        if args.model not in name:
            continue
        if args.start not in name:
            continue
        gribs.append(os.path.join(args.input, name))
    return gribs


def main(args):
    gribs = get_gribs(args)
    print("'%s': %d files" % (args.input, len(gribs)))
    if not gribs:
        sys.exit("no files selected, aborting")
    tag = args.out_tag or os.path.basename(args.input)
    out_fn = os.path.join(args.output, "%s.nc" % tag)
    c = cdo.Cdo()
    try:
        os.makedirs(args.output)
    except FileExistsError:
        pass
    c.cat(input=' '.join(gribs), output=out_fn, options='-r -f nc')


if __name__ == "__main__":
    parser = argparse.ArgumentParser(description=__doc__)
    parser.add_argument('-i', '--input', metavar="DIR", default=".")
    parser.add_argument('-o', '--output', metavar="DIR", default=".")
    parser.add_argument('-t', '--out-tag', metavar="STRING")
    parser.add_argument('--model', metavar="STRING", default="")
    parser.add_argument('--start', metavar="STRING", default="")
    main(parser.parse_args(sys.argv[1:]))
